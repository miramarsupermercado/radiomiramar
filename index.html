<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>R√°dio Miramar</title>
  <link href="https://fonts.googleapis.com/css2?family=Dongle:wght@300;400;700&family=Quicksand:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
  
  <style>
    :root { 
      --primary: #f39c12; 
      --primary-glow: rgba(243, 156, 18, 0.3);
      --bg-dark: #0f1115; 
      --sidebar-bg: #1a1d23; 
      --card-bg: #252932;
      --text-main: #f8f9fa;
      --text-dim: #a0a0a0;
      --accent: #2ecc71;
      --danger: #e74c3c;
    }

    * { box-sizing: border-box; transition: all 0.2s ease; }

    body { 
      font-family: 'Inter', sans-serif; 
      margin: 0; 
      background: var(--bg-dark); 
      color: var(--text-main); 
      width: 133.33vw; 
      height: 133.33vh; 
      transform: scale(0.75); 
      transform-origin: 0 0; 
      overflow: hidden; 
      display: flex;
      flex-direction: column;
    }

    nav { 
      background: var(--sidebar-bg); 
      display: flex; 
      padding: 0 25px; 
      height: 60px;
      align-items: center;
      gap: 30px; 
      border-bottom: 1px solid rgba(255,255,255,0.05);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 100;
    }

    .nav-btn { 
      background: none; border: none; color: var(--text-dim); cursor: pointer; 
      font-weight: 600; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; 
      height: 100%; border-bottom: 3px solid transparent;
    }

    .nav-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

    .main-layout { flex: 1; display: flex; overflow: hidden; width: 100%; }
    #page-player { display: flex; flex: 1; width: 100%; }

    .player-zone { 
      flex: 1; position: relative; display: flex; flex-direction: column; 
      align-items: center; justify-content: center; 
      background: radial-gradient(circle at center, #1e3a8a 0%, #0f172a 100%);
      overflow: hidden; 
    }

    #visualizer { position: absolute; left: 0; width: 100%; height: 60%; pointer-events: none; }
    .player-content { z-index: 10; display: flex; flex-direction: column; align-items: center; width: 100%; padding: 20px; }

    .album-art { 
      width: 280px; height: 280px; background: #000; border-radius: 50%; 
      display: flex; align-items: center; justify-content: center; 
      border: 8px solid #222; box-shadow: 0 15px 35px rgba(0,0,0,0.5), 0 0 20px var(--primary-glow);
      animation: pulse 4s infinite ease-in-out; margin-bottom: 30px;
      position: relative; overflow: hidden;
    }

    #album-img { width: 100%; height: 100%; object-fit: cover; display: none; }

    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.03); border-color: var(--primary); } }

    #status { color: var(--accent); font-size: 1.75rem; text-transform: uppercase; margin-bottom: 15px; font-weight: 700; letter-spacing: 2px; display: flex; align-items: center; gap: 8px; }
    #status::before { content: ""; width: 8px; height: 8px; background: var(--accent); border-radius: 50%; display: inline-block; box-shadow: 0 0 8px var(--accent); }

    #current-title { font-size: 1.8rem; font-weight: 700; margin-bottom: 30px; text-align: center; max-width: 600px; text-shadow: 0 4px 12px rgba(0,0,0,0.5); }

    .controls-row { display: flex; align-items: center; gap: 25px; margin-bottom: 40px; }
    .round-btn { width: 70px; height: 70px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; background: var(--text-main); color: #000; }
    .round-btn:hover { transform: translateY(-3px); background: var(--primary); color: #fff; }
    .btn-secondary { width: 50px; height: 50px; background: rgba(255,255,255,0.1); color: #fff; }

    .progress-container { width: 90%; max-width: 600px; }
    .bar-bg { background: rgba(255,255,255,0.1); height: 10px; border-radius: 10px; overflow: hidden; position: relative; cursor: pointer; }
    #progress-fill { background: linear-gradient(90deg, #d35400, var(--primary)); height: 100%; width: 0%; border-radius: 10px; pointer-events: none; }

    .sidebar { width: 420px; background: var(--sidebar-bg); border-left: 1px solid rgba(255,255,255,0.05); padding: 25px; display: flex; flex-direction: column; }
    .sidebar h4 { color: var(--text-dim); text-transform: uppercase; font-size: 0.7rem; letter-spacing: 2px; margin-bottom: 15px; margin-top: 20px; }

    .search-box { position: relative; margin-bottom: 10px; }
    .search-input { width: 100%; background: #0f1115; border: 1px solid #3d4451; padding: 12px; border-radius: 8px; color: #fff; font-size: 0.85rem; }
    .search-results { 
        position: absolute; top: 100%; left: 0; right: 0; background: #252932; 
        border: 1px solid #3d4451; border-top: none; z-index: 1000; 
        max-height: 300px; overflow-y: auto; display: none; border-radius: 0 0 8px 8px;
        box-shadow: 0 10px 20px rgba(0,0,0,0.5);
    }
    .search-item { 
        padding: 10px 15px; border-bottom: 1px solid rgba(255,255,255,0.05); 
        display: flex; flex-direction: column; gap: 5px; cursor: default;
    }
    .search-item:hover { background: rgba(255,255,255,0.05); }
    .search-item-title { font-size: 0.8rem; font-weight: 600; color: #fff; }
    .search-item-actions { display: flex; gap: 8px; }
    .mini-btn { 
        font-size: 0.65rem; padding: 4px 8px; border-radius: 4px; border: none; 
        cursor: pointer; font-weight: 700; text-transform: uppercase;
    }
    .btn-next { background: var(--accent); color: #000; }
    .btn-add { background: var(--primary); color: #000; }

    .track-item { padding: 12px 15px; border-radius: 10px; margin-bottom: 10px; background: rgba(255,255,255,0.03); font-size: 0.85rem; display: flex; align-items: center; justify-content: space-between; border-left: 3px solid transparent; }
    .track-item:hover { background: rgba(255,255,255,0.06); }
    
    .delete-btn { background: none; border: none; color: var(--text-dim); cursor: pointer; padding: 5px; display: flex; align-items: center; border-radius: 5px; }
    .delete-btn:hover { color: var(--danger); background: rgba(231, 76, 60, 0.1); }

    .btn-pao { background: #d6741d; color: #fff; border: none; padding: 20px; border-radius: 12px; font-weight: 700; cursor: pointer; margin-top: 15px; box-shadow: 0 4px 15px rgba(192, 57, 43, 0.3); }

    #page-config { flex: 1; padding: 60px; overflow-y: auto; display: none; background: var(--bg-dark); }
    .config-card { background: var(--card-bg); padding: 40px; border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.4); max-width: 800px; margin: auto; }

    .input-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; font-size: 0.8rem; color: var(--primary); font-weight: 600; }
    input[type="file"] { background: #1a1d23; border: 1px solid #3d4451; color: #fff; padding: 14px; border-radius: 10px; width: 100%; outline: none; }
    
    .genre-controls { background: rgba(0,0,0,0.2); padding: 20px; border-radius: 15px; margin-top: 15px; display: grid; gap: 15px; }
    .genre-row { display: flex; align-items: center; gap: 15px; }
    .genre-row span { min-width: 120px; font-size: 0.85rem; }
    input[type="range"] { flex: 1; accent-color: var(--primary); cursor: pointer; }
    .percentage-label { min-width: 45px; font-weight: bold; color: var(--accent); }

    .save-btn { background: var(--primary); color: #fff; border: none; padding: 20px; width: 100%; border-radius: 12px; font-weight: 700; cursor: pointer; margin-top: 20px; }
    .status-box { font-size: 0.75rem; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; margin-top: 10px; line-height: 1.6; }
  </style>
</head>
<body>

  <nav>
    <div style="font-family: 'Dongle', sans-serif; font-size: 30px; color: var(--primary); margin-right: 20px; display: flex; align-items: center; gap: 10px; line-height: 0.6;">
    <img src="https://miramarsupermercado.com.br/wp-content/uploads/2024/10/cropped-icone.png" alt="Logo Miramar" style="width: 40px; height: auto;">
    <div style="display: flex; flex-direction: column;">
        <span style="color: #ed6a1b; font-weight: 100; margin-top: 6px">R√ÅDIO</span>
        <span style="color: #ffffff; font-weight: 700;">MIRAMAR</span>
    </div>
</div>
    <button class="nav-btn active" id="btn-player" onclick="showPage('player')">Est√∫dio ao Vivo</button>
    <button class="nav-btn" id="btn-config" onclick="showPage('config')">Configura√ß√µes</button>
  </nav>

  <div class="main-layout">
    <div id="page-player">
      <div class="player-zone">
        <canvas id="visualizer"></canvas>
        <div class="player-content">
          <div id="status">No Ar</div>
          
          <div class="album-art" id="album-container">
            <div id="fallback-icon">
                <svg width="80" height="80" viewBox="0 0 24 24" fill="var(--primary)"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
            </div>
            <img id="album-img" alt="Capa">
          </div>

          <div id="current-title">Aguardando Sincroniza√ß√£o...</div>
          
          <div class="controls-row">
            <button id="playPause" class="round-btn"><svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg></button>
            <button id="nextBtn" class="round-btn btn-secondary"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg></button>
          </div>

          <div class="progress-container">
            <div class="bar-bg" id="prog-container"><div id="progress-fill"></div></div>
            <div style="display:flex; justify-content:space-between; margin-top:12px; color:var(--text-dim); font-size: 0.85rem;">
              <span id="time-current">00:00</span>
              <span id="time-total">00:00</span>
            </div>
          </div>
        </div>
      </div>

      <div class="sidebar">
        <h4>Buscar M√∫sica</h4>
        <div class="search-box">
            <input type="text" class="search-input" id="musicSearch" placeholder="Pesquisar na biblioteca..." oninput="searchMusic(this.value)">
            <div id="search-results" class="search-results"></div>
        </div>

        <h4>Pr√≥ximas M√∫sicas (No Ar)</h4>
        <div id="playlist" style="flex:1; overflow-y:auto;"><div style="text-align: center; color: #555; margin-top: 20px;">Playlist vazia</div></div>
        <button id="playAd" class="btn-pao">üì¢ AVISO P√ÉO (2X)</button>
      </div>
    </div>

    <div id="page-config">
      <div class="config-card">
        <h2 style="margin-top:0">Painel de Controle</h2>
        <p style="font-size: 0.8rem; color: var(--text-dim); margin-bottom: 20px;">Selecione a pasta raiz que cont√©m /Musicas, /Vinhetas, /Hora e /Avisos.</p>
        
        <div class="input-group">
          <label>Pasta Raiz da Esta√ß√£o</label>
          <input id="fMain" type="file" webkitdirectory directory multiple onchange="handleMainDirectory(this)">
        </div>

        <div id="genre-settings" class="genre-controls" style="display:none;">
          <label>Ajuste o Mix de G√™neros</label>
          <div id="genre-list"></div>
          <button onclick="saveCurrentConfigs()" style="background:#27ae60; border:none; color:white; padding:10px; border-radius:8px; cursor:pointer; width:100%; font-weight:bold; margin-top:10px;">üíæ SALVAR PRESET DE G√äNEROS</button>
        </div>

        <div id="status-pastas" class="status-box" style="display:none;"></div>
        
        <button id="build" class="save-btn" style="display:none;">SINCRONIZAR E INICIAR EST√öDIO</button>
      </div>
    </div>
  </div>

  <audio id="audioA"></audio><audio id="audioB"></audio><audio id="audioAds"></audio>

  <script>
    const STORAGE_KEY = 'MIRAMAR_PRO_CONFIGS';
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const compressor = audioCtx.createDynamicsCompressor();
    compressor.threshold.setValueAtTime(-24, audioCtx.currentTime);
    compressor.knee.setValueAtTime(30, audioCtx.currentTime);
    compressor.ratio.setValueAtTime(12, audioCtx.currentTime);
    compressor.attack.setValueAtTime(0.003, audioCtx.currentTime);
    compressor.release.setValueAtTime(0.25, audioCtx.currentTime);

    const analyser = audioCtx.createAnalyser();
    const gainA = audioCtx.createGain(), gainB = audioCtx.createGain(), gainAds = audioCtx.createGain();
    const audioA = document.getElementById('audioA'), audioB = document.getElementById('audioB'), audioAds = document.getElementById('audioAds');
    
    audioCtx.createMediaElementSource(audioA).connect(gainA).connect(analyser);
    audioCtx.createMediaElementSource(audioB).connect(gainB).connect(analyser);
    audioCtx.createMediaElementSource(audioAds).connect(gainAds).connect(analyser);
    
    analyser.connect(compressor);
    compressor.connect(audioCtx.destination);
    analyser.fftSize = 256;

    let playlist = [], currentIndex = -1, activePlayer = audioA, isAdPlaying = false;
    let musicLibrary = {}, filesP3 = [], filesP4 = [], filesAds = [];

    function showPage(p) {
      document.getElementById('page-player').style.display = (p === 'player') ? 'flex' : 'none';
      document.getElementById('page-config').style.display = (p === 'config') ? 'block' : 'none';
      document.getElementById('btn-player').classList.toggle('active', p==='player');
      document.getElementById('btn-config').classList.toggle('active', p==='config');
    }

    function handleMainDirectory(input) {
      musicLibrary = {}; filesP3 = []; filesP4 = []; filesAds = [];
      const files = Array.from(input.files);
      
      files.forEach(file => {
        const path = file.webkitRelativePath.toLowerCase();
        if (!file.type.startsWith('audio')) return;

        if (path.includes('/musicas/')) {
          const parts = file.webkitRelativePath.split('/');
          const mIdx = parts.findIndex(p => p.toLowerCase() === 'musicas');
          const genre = parts[mIdx + 1];
          if (genre && parts[mIdx + 2]) {
            if (!musicLibrary[genre]) musicLibrary[genre] = [];
            musicLibrary[genre].push(file);
          }
        } else if (path.includes('/vinhetas/')) {
          filesP3.push(file);
        } else if (path.includes('/hora/')) {
          filesP4.push(file);
        } else if (path.includes('/avisos/')) {
          filesAds.push(file);
        }
      });

      updateStatusUI();
    }

    function updateStatusUI() {
      const stats = document.getElementById('status-pastas');
      const mCount = Object.keys(musicLibrary).length;
      stats.style.display = 'block';
      stats.innerHTML = `
        ${mCount > 0 ? '‚úÖ' : '‚ùå'} G√™neros musicais: ${mCount}<br>
        ${filesP3.length > 0 ? '‚úÖ' : '‚ùå'} Vinhetas (P3): ${filesP3.length}<br>
        ${filesP4.length > 0 ? '‚úÖ' : '‚ùå'} Locu√ß√µes Hora (P4): ${filesP4.length}<br>
        ${filesAds.length > 0 ? '‚úÖ' : '‚ùå'} Avisos (Ads): ${filesAds.length}
      `;

      if (mCount > 0) {
        document.getElementById('genre-settings').style.display = 'block';
        document.getElementById('build').style.display = 'block';
        generateGenreSliders();
      }
    }

    function generateGenreSliders() {
      const container = document.getElementById('genre-list');
      container.innerHTML = '';
      const genres = Object.keys(musicLibrary);
      const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');

      genres.forEach(genre => {
        const val = saved[genre] !== undefined ? saved[genre] : Math.floor(100 / genres.length);
        const row = document.createElement('div');
        row.className = 'genre-row';
        row.innerHTML = `
          <span>${genre}</span>
          <input type="range" class="genre-range" data-genre="${genre}" value="${val}" min="0" max="100" oninput="rebalance(this)">
          <span class="percentage-label">${val}%</span>
        `;
        container.appendChild(row);
      });
    }

    function saveCurrentConfigs() {
      const data = {};
      document.querySelectorAll('.genre-range').forEach(i => data[i.dataset.genre] = i.value);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      alert("‚úÖ Preset de g√™neros salvo!");
    }

    function rebalance(changedInput) {
      const all = Array.from(document.querySelectorAll('.genre-range'));
      const changedValue = parseInt(changedInput.value);
      const others = all.filter(i => i !== changedInput);
      const totalOthers = 100 - changedValue;
      const currentSumOthers = others.reduce((s, i) => s + parseInt(i.value), 0);

      others.forEach(i => {
        const ratio = currentSumOthers > 0 ? parseInt(i.value) / currentSumOthers : 1 / others.length;
        i.value = Math.round(ratio * totalOthers);
        i.nextElementSibling.textContent = i.value + '%';
      });
      changedInput.nextElementSibling.textContent = changedInput.value + '%';
    }

    document.getElementById('build').onclick = () => {
      const MAX = 300;
      let pool = [];
      document.querySelectorAll('.genre-range').forEach(input => {
        const genre = input.dataset.genre;
        const count = Math.round(MAX * (parseInt(input.value) / 100));
        if (count > 0 && musicLibrary[genre]) {
          let s = Array.from(musicLibrary[genre]).sort(() => Math.random() - 0.5).slice(0, count);
          pool.push(...s.map(f => ({ file: f, isP1: true })));
        }
      });

      pool.sort(() => Math.random() - 0.5).slice(0, MAX);
      let p3 = Array.from(filesP3).sort(() => Math.random() - 0.5);
      playlist = [];
      let count = 0, ptr3 = 0;

      pool.forEach(m => {
        playlist.push(m);
        count++;
        if (count % 2 === 0 && filesP4.length) playlist.push({ isHoraDinamica: true });
        if (p3.length) {
          playlist.push({ file: p3[ptr3 % p3.length], isP3: true });
          ptr3++;
        }
      });

      currentIndex = -1;
      showPage('player');
      play(0);
    };

    function searchMusic(query) {
        const resDiv = document.getElementById('search-results');
        if (!query || query.length < 2) { resDiv.style.display = 'none'; return; }
        
        let found = [];
        Object.values(musicLibrary).flat().forEach(file => {
            if (file.name.toLowerCase().includes(query.toLowerCase())) {
                found.push(file);
            }
        });

        if (found.length) {
            resDiv.style.display = 'block';
            resDiv.innerHTML = found.slice(0, 10).map((file, i) => `
                <div class="search-item">
                    <div class="search-item-title">${file.name}</div>
                    <div class="search-item-actions">
                        <button class="mini-btn btn-next" onclick="addToPlaylist('${file.name}', true)">Tocar como Pr√≥xima</button>
                        <button class="mini-btn btn-add" onclick="addToPlaylist('${file.name}', false)">Add √†s Pr√≥ximas 5</button>
                    </div>
                </div>
            `).join('');
        } else {
            resDiv.style.display = 'none';
        }
    }

    function addToPlaylist(fileName, isNext) {
        let file = null;
        Object.values(musicLibrary).flat().forEach(f => { if(f.name === fileName) file = f; });
        if(!file) return;

        // Criar o bloco completo para a nova m√∫sica
        const block = [{ file: file, isP1: true }];
        if (filesP3.length) {
            block.push({ file: filesP3[Math.floor(Math.random() * filesP3.length)], isP3: true });
        }
        if (filesP4.length && Math.random() > 0.5) {
            block.push({ isHoraDinamica: true });
        }

        // Fun√ß√£o para achar o fim do bloco de uma m√∫sica na posi√ß√£o X
        function findEndOfBlock(startIndex) {
            let end = startIndex;
            for (let i = startIndex + 1; i < playlist.length; i++) {
                if (playlist[i] && !playlist[i].isP1) end = i;
                else break;
            }
            return end;
        }

        let insertPos;
        if (isNext) {
            // Se "Tocar Pr√≥xima", pula a m√∫sica atual e todos os itens (vinheta/hora) atrelados a ela
            insertPos = findEndOfBlock(currentIndex) + 1;
        } else {
            // Se "Pr√≥ximas 5", pula 5 m√∫sicas e seus respectivos blocos
            let musicCount = 0;
            let currentCheck = currentIndex;
            while (musicCount < 5 && currentCheck < playlist.length - 1) {
                currentCheck = findEndOfBlock(currentCheck + 1);
                musicCount++;
            }
            insertPos = currentCheck + 1;
        }

        playlist.splice(insertPos, 0, ...block);
        document.getElementById('musicSearch').value = '';
        document.getElementById('search-results').style.display = 'none';
        render();
    }

    async function play(i, isManual = false) {
      if (i < 0 || i >= playlist.length) return;
      if (audioCtx.state === 'suspended') await audioCtx.resume();
      let item = playlist[i];

      if (item.isHoraDinamica) { runIsolatedHora(i); return; }

      const prev = activePlayer; 
      const prevG = (prev === audioA) ? gainA : gainB;
      
      audioA.onended = null; audioA.ontimeupdate = null;
      audioB.onended = null; audioB.ontimeupdate = null;

      if (isManual || (playlist[currentIndex]?.isP1 && item.isP3)) {
        activePlayer = (prev === audioA) ? audioB : audioA;
        const curG = (activePlayer === audioA) ? gainA : gainB;
        curG.gain.cancelScheduledValues(audioCtx.currentTime);
        if (isManual) {
          prevG.gain.setTargetAtTime(0, audioCtx.currentTime, 1.2);
          setTimeout(() => { if (prev.src) prev.pause(); }, 4500);
          curG.gain.setValueAtTime(0, audioCtx.currentTime);
          curG.gain.linearRampToValueAtTime(1, audioCtx.currentTime + 4);
        } else {
          curG.gain.setValueAtTime(1, audioCtx.currentTime);
        }
      } else {
        audioA.pause(); audioB.pause();
        activePlayer = audioA;
        gainA.gain.setValueAtTime(0, audioCtx.currentTime);
        gainA.gain.linearRampToValueAtTime(1, audioCtx.currentTime + 1.5);
      }

      currentIndex = i;
      activePlayer.src = URL.createObjectURL(item.file);
      updateAlbumArt(item.file);
      activePlayer.play();
      document.getElementById('current-title').textContent = item.file.name.replace(/\.[^/.]+$/, "");
      render();

      activePlayer.ontimeupdate = function() {
        if(this !== activePlayer) return;
        const pct = (this.currentTime / this.duration * 100);
        document.getElementById('progress-fill').style.width = pct + "%";
        document.getElementById('time-current').textContent = formatTime(this.currentTime);
        document.getElementById('time-total').textContent = formatTime(this.duration);
        
        if (item.isP1 && playlist[currentIndex+1]?.isP3 && !item.overlapStarted && (this.duration - this.currentTime <= 2.2)) {
          item.overlapStarted = true;
          play(currentIndex+1);
        }
      };
      activePlayer.onended = () => { if(!item.overlapStarted) play(currentIndex+1); };
    }

    function updateAlbumArt(file) {
        const imgEl = document.getElementById('album-img'), fallback = document.getElementById('fallback-icon');
        if (!file) return;
        jsmediatags.read(file, {
            onSuccess: function(tag) {
                if (tag.tags.picture) {
                    const { data, format } = tag.tags.picture;
                    let base64String = "";
                    for (let i = 0; i < data.length; i++) base64String += String.fromCharCode(data[i]);
                    imgEl.src = `data:${format};base64,${window.btoa(base64String)}`;
                    imgEl.style.display = 'block'; fallback.style.display = 'none';
                } else { imgEl.style.display = 'none'; fallback.style.display = 'block'; }
            },
            onError: function() { imgEl.style.display = 'none'; fallback.style.display = 'block'; }
        });
    }

    async function runIsolatedHora(idx) {
      audioA.pause(); audioB.pause();
      audioA.onended = null; audioA.ontimeupdate = null;
      audioB.onended = null; audioB.ontimeupdate = null;
      const now = new Date();
      const hStr = "HRS" + now.getHours().toString().padStart(2, '0');
      const mStr = "MIN" + now.getMinutes().toString().padStart(2, '0');
      const fH = filesP4.find(f => f.name.toUpperCase().includes(hStr));
      const fM = filesP4.find(f => f.name.toUpperCase().includes(mStr));
      if (!fH) return play(idx + 1);
      currentIndex = idx; activePlayer = audioA;
      gainA.gain.setValueAtTime(1.5, audioCtx.currentTime);
      document.getElementById('current-title').textContent = `üé§ Hora Certa: ${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`;
      const playWait = (file) => new Promise(resolve => {
        activePlayer.src = URL.createObjectURL(file);
        activePlayer.onended = resolve; activePlayer.play().catch(resolve);
      });
      await playWait(fH);
      if (fM) { await new Promise(r => setTimeout(r, 400)); await playWait(fM); }
      await new Promise(r => setTimeout(r, 800));
      play(idx + 1);
    }

    document.getElementById('prog-container').onclick = function(e) {
      if (currentIndex === -1 || !activePlayer.duration) return;
      const pct = (e.clientX - this.getBoundingClientRect().left) / this.getBoundingClientRect().width;
      activePlayer.currentTime = pct * activePlayer.duration;
    };

    function render() {
      const el = document.getElementById('playlist');
      const future = playlist.map((item, idx) => ({ ...item, originalIdx: idx }))
        .slice(currentIndex + 1).filter(it => it.isP1).slice(0, 5);
      if (!future.length) { el.innerHTML = '<div style="text-align:center; padding:20px; color:#555">Fim da lista</div>'; return; }
      el.innerHTML = future.map(it => `
        <div class="track-item">
          <div style="display: flex; align-items: center; overflow: hidden; white-space: nowrap;">
            <span style="opacity:0.5; margin-right:10px; font-size:0.7rem;">PR√ìXIMA</span>
            <div style="overflow: hidden; text-overflow: ellipsis;">${it.file.name.substring(0,35)}</div>
          </div>
          <button class="delete-btn" onclick="removeFromPlaylist(${it.originalIdx})">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
          </button>
        </div>
      `).join('');
    }

    function removeFromPlaylist(index) {
        if (playlist[index]?.isP1) {
            let count = 1;
            for (let i = index + 1; i < playlist.length; i++) {
                if (!playlist[i].isP1) count++;
                else break;
            }
            playlist.splice(index, count);
        } else { playlist.splice(index, 1); }
        render();
    }

    function formatTime(t) { if (isNaN(t)) return "00:00"; const m = Math.floor(t/60), s = Math.floor(t%60); return `${m}:${s<10?'0':''}${s}`; }
    document.getElementById('playPause').onclick = () => { if (currentIndex === -1) play(0); else activePlayer.paused ? activePlayer.play() : activePlayer.pause(); };
    document.getElementById('nextBtn').onclick = () => play(currentIndex+1, true);
    
    // --- CORRE√á√ÉO DA REPRODU√á√ÉO DO BOT√ÉO AVISO ---
    document.getElementById('playAd').onclick = async () => {
        if (!filesAds.length || isAdPlaying) return;
        if (audioCtx.state === 'suspended') await audioCtx.resume();
        isAdPlaying = true;

        // Efeito Ducking (abaixa volume da m√∫sica)
        const currentGain = (activePlayer === audioA) ? gainA : gainB;
        currentGain.gain.setTargetAtTime(0.2, audioCtx.currentTime, 0.5);

        let adCount = 0;
        function playAdSequence() {
            if (adCount < 2) {
                const randomAd = filesAds[Math.floor(Math.random() * filesAds.length)];
                audioAds.src = URL.createObjectURL(randomAd);
                gainAds.gain.setValueAtTime(2.0, audioCtx.currentTime); // Volume forte
                audioAds.onended = () => { adCount++; setTimeout(playAdSequence, 100); };
                audioAds.play();
            } else {
                currentGain.gain.linearRampToValueAtTime(1.0, audioCtx.currentTime + 1.5);
                isAdPlaying = false;
            }
        }
        playAdSequence();
    };
    // ---------------------------------------------

    const canvas = document.getElementById('visualizer'), ctx = canvas.getContext('2d');
    function draw() {
      requestAnimationFrame(draw);
      canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight;
      const data = new Uint8Array(analyser.frequencyBinCount);
      analyser.getByteFrequencyData(data);
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      let g = ctx.createLinearGradient(0, canvas.height, 0, 0);
      g.addColorStop(0, "rgba(243, 156, 18, 0)"); g.addColorStop(1, "rgba(243, 156, 18, 0.6)");
      const barW = (canvas.width / data.length) * 2;
      for(let i=0; i<data.length; i++) {
        let h = data[i] * (canvas.height / 255); ctx.fillStyle = g;
        ctx.fillRect(i*(barW+2), canvas.height - h, barW, h);
      }
    }
    draw();
    document.addEventListener('click', (e) => { if (!e.target.closest('.search-box')) document.getElementById('search-results').style.display = 'none'; });
  </script>
</body>
</html>


<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Miramar Pro - M3U Edition</title>
    <style>
        /* Mantendo o estilo b√°sico para funcionamento */
        body { background: #111; color: white; font-family: sans-serif; }
        .active { color: orange; }
        #visualizer { width: 100%; height: 100px; background: #222; }
        .track-item { display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px solid #333; }
        #progress-fill { height: 5px; background: orange; width: 0%; transition: width 0.1s; }
        #prog-container { width: 100%; background: #444; cursor: pointer; height: 5px; }
    </style>
</head>
<body>

    <div id="page-player" style="display:none; flex-direction:column; gap:20px; padding:20px;">
        <canvas id="visualizer"></canvas>
        <div id="album-art">
            <img id="album-img" style="display:none; width:200px;">
            <div id="fallback-icon">üìª</div>
        </div>
        <h2 id="current-title">Aguardando Playlist...</h2>
        <div id="prog-container">
            <div id="progress-fill"></div>
        </div>
        <div>
            <span id="time-current">00:00</span> / <span id="time-total">00:00</span>
        </div>
        <button id="playPause">Play/Pause</button>
        <button id="nextBtn">Pr√≥xima</button>
        <button id="playAd">Inserir Aviso/Ad</button>
        
        <input type="text" id="musicSearch" placeholder="Buscar m√∫sica..." oninput="searchMusic(this.value)">
        <div id="search-results" style="display:none; background:#333; padding:10px;"></div>
        
        <div id="playlist"></div>
    </div>

    <div id="page-config" style="display:block; padding:20px;">
        <h3>Configura√ß√£o via M3U (GitHub)</h3>
        <p id="status-pastas">Carregando arquivo lista.m3u...</p>
        
        <div id="genre-settings" style="display:none;">
            <div id="genre-list"></div>
            <button id="build" style="display:none; margin-top:20px; padding:10px 20px; background:green; color:white; border:none; cursor:pointer;">
                GERAR PLAYLIST E INICIAR R√ÅDIO
            </button>
        </div>
    </div>

    <nav style="position:fixed; bottom:0; width:100%; display:flex; background:#222;">
        <button id="btn-config" class="active" onclick="showPage('config')">Configura√ß√µes</button>
        <button id="btn-player" onclick="showPage('player')">Player</button>
    </nav>

    <audio id="audioA"></audio>
    <audio id="audioB"></audio>
    <audio id="audioAds"></audio>

<script>
    const STORAGE_KEY = 'MIRAMAR_PRO_CONFIGS';
    const STATE_KEY = 'MIRAMAR_PLAYER_STATE'; 
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    // --- CONFIGURA√á√ÉO DE NIVELAMENTO AUTOM√ÅTICO (AGC) ---
    const compressor = audioCtx.createDynamicsCompressor();
    compressor.threshold.setValueAtTime(-40, audioCtx.currentTime);
    compressor.knee.setValueAtTime(40, audioCtx.currentTime);
    compressor.ratio.setValueAtTime(12, audioCtx.currentTime);
    compressor.attack.setValueAtTime(0.01, audioCtx.currentTime);
    compressor.release.setValueAtTime(0.25, audioCtx.currentTime);

    const analyser = audioCtx.createAnalyser();
    
    const gainA = audioCtx.createGain(), gainB = audioCtx.createGain(), gainAds = audioCtx.createGain();
    gainA.gain.value = 1.5; 
    gainB.gain.value = 1.5;
    gainAds.gain.value = 1.5;

    const audioA = document.getElementById('audioA'), audioB = document.getElementById('audioB'), audioAds = document.getElementById('audioAds');
    
    // PERMISS√ÉO CORS PARA GITHUB PAGES
    audioA.crossOrigin = "anonymous";
    audioB.crossOrigin = "anonymous";
    audioAds.crossOrigin = "anonymous";

    audioCtx.createMediaElementSource(audioA).connect(gainA).connect(analyser);
    audioCtx.createMediaElementSource(audioB).connect(gainB).connect(analyser);
    audioCtx.createMediaElementSource(audioAds).connect(gainAds).connect(analyser);
    
    analyser.connect(compressor);
    compressor.connect(audioCtx.destination);
    analyser.fftSize = 256;

    let playlist = [], currentIndex = -1, activePlayer = audioA, isAdPlaying = false;
    let musicLibrary = {}, filesP3 = [], filesP4 = [], filesAds = [];
    let objectUrls = []; 

    let schedulerInterval = null;

    // --- NOVA FUN√á√ÉO PARA CARREGAR M3U NO GITHUB ---
    async function loadM3UFromGithub(fileName) {
        try {
            const response = await fetch(fileName);
            const text = await response.text();
            const lines = text.split('\n');
            
            musicLibrary = {}; filesP3 = []; filesP4 = []; filesAds = [];

            lines.forEach(line => {
                line = line.trim();
                if (line === "" || line.startsWith("#")) return;

                const fileNameOnly = line.split('/').pop().replace(/%20/g, ' ');
                // Objeto compat√≠vel com a estrutura do seu c√≥digo original
                const trackItem = {
                    url: line, 
                    isExternal: true,
                    file: { name: fileNameOnly }
                };

                const path = line.toLowerCase();
                if (path.includes('/vinhetas/')) {
                    filesP3.push(trackItem);
                } else if (path.includes('/hora/')) {
                    filesP4.push(trackItem);
                } else if (path.includes('/avisos/')) {
                    filesAds.push(trackItem);
                } else {
                    // Tenta extrair o g√™nero pela pasta (ex: musicas/Rock/musica.mp3)
                    const parts = line.split('/');
                    const mIdx = parts.findIndex(p => p.toLowerCase() === 'musicas');
                    const genre = (mIdx !== -1 && parts[mIdx + 1]) ? parts[mIdx + 1] : "Geral";
                    
                    if (!musicLibrary[genre]) musicLibrary[genre] = [];
                    musicLibrary[genre].push(trackItem);
                }
            });

            updateStatusUI();
        } catch (err) {
            document.getElementById('status-pastas').innerHTML = "‚ùå Erro ao carregar lista.m3u";
            console.error(err);
        }
    }

    // --- ADAPTA√á√ÉO DA FUN√á√ÉO DE URL PARA ACEITAR M3U ---
    function createSafeUrl(item) {
        // Se for um item do M3U, retorna a URL diretamente
        if (item && item.url) return item.url;
        
        // Se for um arquivo de input local (fallback)
        const file = item.file || item;
        if (objectUrls.length > 10) URL.revokeObjectURL(objectUrls.shift());
        const url = URL.createObjectURL(file);
        objectUrls.push(url);
        return url;
    }

    // --- MANTENDO TODAS AS FUN√á√ïES ORIGINAIS INTACTAS ---

    function showPage(p) {
      document.getElementById('page-player').style.display = (p === 'player') ? 'flex' : 'none';
      document.getElementById('page-config').style.display = (p === 'config') ? 'block' : 'none';
      document.getElementById('btn-player').classList.toggle('active', p==='player');
      document.getElementById('btn-config').classList.toggle('active', p==='config');
    }

    function updateStatusUI() {
      const stats = document.getElementById('status-pastas');
      const mCount = Object.keys(musicLibrary).length;
      stats.style.display = 'block';
      stats.innerHTML = `
        ${mCount > 0 ? '‚úÖ' : '‚ùå'} G√™neros detectados: ${mCount}<br>
        ${filesP3.length > 0 ? '‚úÖ' : '‚ùå'} Vinhetas (P3): ${filesP3.length}<br>
        ${filesP4.length > 0 ? '‚úÖ' : '‚ùå'} Locu√ß√µes Hora (P4): ${filesP4.length}<br>
        ${filesAds.length > 0 ? '‚úÖ' : '‚ùå'} Avisos (Ads): ${filesAds.length}
      `;

      if (mCount > 0) {
        document.getElementById('genre-settings').style.display = 'block';
        if(!document.getElementById('scheduler-settings')) {
            const schedDiv = document.createElement('div');
            schedDiv.id = 'scheduler-settings';
            schedDiv.innerHTML = `
                <h4>Agendamento Autom√°tico</h4>
                <input type="time" id="startTime"> √†s <input type="time" id="endTime">
            `;
            document.getElementById('genre-settings').insertBefore(schedDiv, document.getElementById('genre-list'));
        }
        document.getElementById('build').style.display = 'block';
        generateGenreSliders();
      }
    }

    function startScheduler() {
        if (schedulerInterval) clearInterval(schedulerInterval);
        schedulerInterval = setInterval(() => {
            if (playlist.length === 0) return;
            const now = new Date();
            const currentTimeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;

            if (startTime && currentTimeStr === startTime && activePlayer.paused && currentIndex === -1) {
                play(0);
            }
            if (endTime && currentTimeStr === endTime && !activePlayer.paused) {
                activePlayer.pause();
            }
        }, 1000);
    }

    function generateGenreSliders() {
      const container = document.getElementById('genre-list');
      container.innerHTML = '';
      const genres = Object.keys(musicLibrary);
      const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');

      genres.forEach(genre => {
        const val = saved[genre] !== undefined ? saved[genre] : Math.floor(100 / genres.length);
        const row = document.createElement('div');
        row.innerHTML = `
          <span>${genre}</span>
          <input type="range" class="genre-range" data-genre="${genre}" value="${val}" min="0" max="100" oninput="rebalance(this)">
          <span>${val}%</span>
        `;
        container.appendChild(row);
      });
    }

    function rebalance(changedInput) {
      const all = Array.from(document.querySelectorAll('.genre-range'));
      const changedValue = parseInt(changedInput.value);
      const others = all.filter(i => i !== changedInput);
      const totalOthers = 100 - changedValue;
      const currentSumOthers = others.reduce((s, i) => s + parseInt(i.value), 0);
      others.forEach(i => {
        const ratio = currentSumOthers > 0 ? parseInt(i.value) / currentSumOthers : 1 / others.length;
        i.value = Math.round(ratio * totalOthers);
        i.nextElementSibling.textContent = i.value + '%';
      });
      changedInput.nextElementSibling.textContent = changedInput.value + '%';
    }

    document.getElementById('build').onclick = () => {
      const MAX = 300;
      let pool = [];

      function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }

      document.querySelectorAll('.genre-range').forEach(input => {
        const genre = input.dataset.genre;
        const countNeeded = Math.round(MAX * (parseInt(input.value) / 100));
        if (countNeeded > 0 && musicLibrary[genre]) {
          let genrePool = shuffle([...musicLibrary[genre]]);
          let selected = genrePool.slice(0, countNeeded);
          pool.push(...selected.map(trackObj => ({ ...trackObj, isP1: true })));
        }
      });

      shuffle(pool);
      pool = pool.slice(0, MAX);
      let p3 = Array.from(filesP3);
      if (p3.length) shuffle(p3);

      playlist = [];
      let count = 0, ptr3 = 0;

      pool.forEach(m => {
        playlist.push(m);
        count++;
        if (count % 2 === 0 && filesP4.length) playlist.push({ isHoraDinamica: true });
        if (p3.length) {
          playlist.push({ ...p3[ptr3 % p3.length], isP3: true });
          ptr3++;
        }
      });

      currentIndex = -1;
      startScheduler();
      showPage('player');
      render();
    };

    async function play(i, isManual = false) {
      if (i < 0 || i >= playlist.length) return;
      if (audioCtx.state === 'suspended') await audioCtx.resume();
      let item = playlist[i];

      if (item.isHoraDinamica) { runIsolatedHora(i); return; }

      const prev = activePlayer; 
      const prevG = (prev === audioA) ? gainA : gainB;
      
      audioA.onended = null; audioA.ontimeupdate = null;
      audioB.onended = null; audioB.ontimeupdate = null;

      if (isManual || (playlist[currentIndex]?.isP1 && item.isP3)) {
        activePlayer = (prev === audioA) ? audioB : audioA;
        const curG = (activePlayer === audioA) ? gainA : gainB;
        curG.gain.cancelScheduledValues(audioCtx.currentTime);
        if (isManual) {
          prevG.gain.setTargetAtTime(0, audioCtx.currentTime, 1.2);
          setTimeout(() => { if (prev.src) prev.pause(); }, 4500);
          curG.gain.setValueAtTime(0, audioCtx.currentTime);
          curG.gain.linearRampToValueAtTime(1.5, audioCtx.currentTime + 4);
        } else {
          curG.gain.setValueAtTime(1.5, audioCtx.currentTime);
        }
      } else {
        audioA.pause(); audioB.pause();
        activePlayer = audioA;
        gainA.gain.setValueAtTime(0, audioCtx.currentTime);
        gainA.gain.linearRampToValueAtTime(1.5, audioCtx.currentTime + 1.5);
      }

      currentIndex = i;
      
      try {
        activePlayer.src = createSafeUrl(item);
        activePlayer.play().catch(e => play(currentIndex + 1));
        localStorage.setItem(STATE_KEY, JSON.stringify({ index: i }));
      } catch (err) {
        play(currentIndex + 1);
      }

      document.getElementById('current-title').textContent = item.file.name;
      render();

      activePlayer.ontimeupdate = function() {
        if(this !== activePlayer) return;
        const pct = (this.currentTime / this.duration * 100);
        document.getElementById('progress-fill').style.width = pct + "%";
        document.getElementById('time-current').textContent = formatTime(this.currentTime);
        document.getElementById('time-total').textContent = formatTime(this.duration);
        
        if (item.isP1 && playlist[currentIndex+1]?.isP3 && !item.overlapStarted && (this.duration - this.currentTime <= 2.2)) {
          item.overlapStarted = true;
          play(currentIndex+1);
        }
      };
      activePlayer.onended = () => { if(!item.overlapStarted) play(currentIndex+1); };
    }

    async function runIsolatedHora(idx) {
      audioA.pause(); audioB.pause();
      const now = new Date();
      const hStr = "HRS" + now.getHours().toString().padStart(2, '0');
      const mStr = "MIN" + now.getMinutes().toString().padStart(2, '0');
      const fH = filesP4.find(f => f.file.name.toUpperCase().includes(hStr));
      const fM = filesP4.find(f => f.file.name.toUpperCase().includes(mStr));
      if (!fH) return play(idx + 1);
      currentIndex = idx; activePlayer = audioA;
      gainA.gain.setValueAtTime(2.0, audioCtx.currentTime); 
      document.getElementById('current-title').textContent = `üé§ Hora Certa`;
      const playWait = (item) => new Promise(resolve => {
        activePlayer.src = createSafeUrl(item);
        activePlayer.onended = resolve; activePlayer.play().catch(resolve);
      });
      await playWait(fH);
      if (fM) { await new Promise(r => setTimeout(r, 400)); await playWait(fM); }
      await new Promise(r => setTimeout(r, 800));
      play(idx + 1);
    }

    function render() {
      const el = document.getElementById('playlist');
      const future = playlist.map((item, idx) => ({ ...item, originalIdx: idx }))
        .slice(currentIndex + 1).filter(it => it.isP1).slice(0, 5);
      if (!future.length) { el.innerHTML = 'Fim da lista'; return; }
      el.innerHTML = future.map(it => `
        <div class="track-item">
          <span>${it.file.name}</span>
        </div>
      `).join('');
    }

    function formatTime(t) { if (isNaN(t)) return "00:00"; const m = Math.floor(t/60), s = Math.floor(t%60); return `${m}:${s<10?'0':''}${s}`; }
    
    document.getElementById('playPause').onclick = () => { 
        if (currentIndex === -1) play(0); 
        else activePlayer.paused ? activePlayer.play() : activePlayer.pause(); 
    };
    
    document.getElementById('nextBtn').onclick = () => play(currentIndex+1, true);

    // Visualizador
    const canvas = document.getElementById('visualizer'), ctx = canvas.getContext('2d');
    function draw() {
      requestAnimationFrame(draw);
      canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight;
      const data = new Uint8Array(analyser.frequencyBinCount);
      analyser.getByteFrequencyData(data);
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "orange";
      const barW = (canvas.width / data.length) * 2;
      for(let i=0; i<data.length; i++) {
        let h = data[i] * (canvas.height / 255);
        ctx.fillRect(i*(barW+2), canvas.height - h, barW, h);
      }
    }
    draw();

    // INICIALIZA√á√ÉO
    window.onload = () => {
        loadM3UFromGithub('lista.m3u'); // Nome do seu arquivo no GitHub
    };
</script>
</body>
</html>

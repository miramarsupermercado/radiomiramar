<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>R√°dio Miramar - Est√∫dio Profissional</title>
  <link href="https://fonts.googleapis.com/css2?family=Dongle:wght@300;400;700&family=Quicksand:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root { 
      --primary: #f39c12; 
      --primary-glow: rgba(243, 156, 18, 0.3);
      --bg-dark: #0f1115; 
      --sidebar-bg: #1a1d23; 
      --card-bg: #252932;
      --text-main: #f8f9fa;
      --text-dim: #a0a0a0;
      --accent: #2ecc71;
      --danger: #e74c3c;
    }

    * { box-sizing: border-box; transition: all 0.2s ease; }

    body { 
      font-family: 'Inter', sans-serif; 
      margin: 0; 
      background: var(--bg-dark); 
      color: var(--text-main); 
      width: 133.33vw; 
      height: 133.33vh; 
      transform: scale(0.75); 
      transform-origin: 0 0; 
      overflow: hidden; 
      display: flex;
      flex-direction: column;
    }

    nav { 
      background: var(--sidebar-bg); 
      display: flex; 
      padding: 0 25px; 
      height: 60px;
      align-items: center;
      gap: 30px; 
      border-bottom: 1px solid rgba(255,255,255,0.05);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 100;
    }

    .nav-btn { background: none; border: none; color: var(--text-dim); cursor: pointer; font-weight: 600; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; height: 100%; border-bottom: 3px solid transparent; }
    .nav-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

    .main-layout { flex: 1; display: flex; overflow: hidden; width: 100%; }
    #page-player { display: flex; flex: 1; width: 100%; }

    .player-zone { flex: 1; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(circle at center, #1e3a8a 0%, #0f172a 100%); overflow: hidden; }
    #visualizer { position: absolute; left: 0; width: 100%; height: 60%; pointer-events: none; }
    .player-content { z-index: 10; display: flex; flex-direction: column; align-items: center; width: 100%; padding: 20px; }

    .album-art { width: 280px; height: 280px; background: #000; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 8px solid #222; box-shadow: 0 15px 35px rgba(0,0,0,0.5), 0 0 20px var(--primary-glow); animation: pulse 4s infinite ease-in-out; margin-bottom: 30px; position: relative; overflow: hidden; }
    #album-img { width: 100%; height: 100%; object-fit: cover; display: none; }

    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.03); border-color: var(--primary); } }

    #status { color: var(--accent); font-size: 1.75rem; text-transform: uppercase; margin-bottom: 15px; font-weight: 700; letter-spacing: 2px; display: flex; align-items: center; gap: 8px; }
    #status::before { content: ""; width: 8px; height: 8px; background: var(--accent); border-radius: 50%; display: inline-block; box-shadow: 0 0 8px var(--accent); }

    #current-title { font-size: 1.8rem; font-weight: 700; margin-bottom: 30px; text-align: center; max-width: 600px; text-shadow: 0 4px 12px rgba(0,0,0,0.5); }

    .controls-row { display: flex; align-items: center; gap: 25px; margin-bottom: 40px; }
    .round-btn { width: 70px; height: 70px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; background: var(--text-main); color: #000; }
    .round-btn:hover { transform: translateY(-3px); background: var(--primary); color: #fff; }
    .btn-secondary { width: 50px; height: 50px; background: rgba(255,255,255,0.1); color: #fff; }
    .btn-mute.active { color: var(--danger); background: rgba(231, 76, 60, 0.2); }

    .progress-container { width: 90%; max-width: 600px; }
    .bar-bg { background: rgba(255,255,255,0.1); height: 14px; border-radius: 10px; overflow: hidden; position: relative; cursor: pointer; }
    #progress-fill { background: linear-gradient(90deg, #d35400, var(--primary)); height: 100%; width: 0%; border-radius: 10px; pointer-events: none; }

    .sidebar { width: 420px; background: var(--sidebar-bg); border-left: 1px solid rgba(255,255,255,0.05); padding: 25px; display: flex; flex-direction: column; }
    .sidebar h4 { color: var(--text-dim); text-transform: uppercase; font-size: 0.7rem; letter-spacing: 2px; margin-bottom: 15px; margin-top: 20px; }

    .search-box { position: relative; margin-bottom: 10px; }
    .search-input { width: 100%; background: #0f1115; border: 1px solid #3d4451; padding: 12px; border-radius: 8px; color: #fff; font-size: 0.85rem; }
    .search-results { position: absolute; top: 100%; left: 0; right: 0; background: #252932; border: 1px solid #3d4451; border-top: none; z-index: 1000; max-height: 400px; overflow-y: auto; display: none; border-radius: 0 0 8px 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }

    .search-item { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .search-item:last-child { border-bottom: none; }
    .search-item-name { display: block; font-size: 0.85rem; margin-bottom: 8px; color: #fff; }
    .search-item-actions { display: flex; gap: 8px; }
    .btn-action { flex: 1; padding: 6px; font-size: 0.65rem; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; text-transform: uppercase; }
    .btn-next { background: var(--primary); color: #fff; }
    .btn-last { background: #555; color: #fff; }

    .track-item { 
      padding: 12px 15px; 
      border-radius: 10px; 
      margin-bottom: 10px; 
      background: rgba(255,255,255,0.03); 
      font-size: 0.85rem; 
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }
    .track-name { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; }
    .remove-btn { 
      background: none; 
      border: none; 
      color: var(--text-dim); 
      cursor: pointer; 
      padding: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .remove-btn:hover { color: var(--danger); }

    .btn-pao { background: #d6741d; color: #fff; border: none; padding: 20px; border-radius: 12px; font-weight: 700; cursor: pointer; margin-top: 15px; width: 100%; }

    #page-config { flex: 1; padding: 60px; overflow-y: auto; display: none; background: var(--bg-dark); }
    .config-card { background: var(--card-bg); padding: 40px; border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.4); max-width: 800px; margin: auto; }

    .save-btn { background: var(--primary); color: #fff; border: none; padding: 20px; width: 100%; border-radius: 12px; font-weight: 700; cursor: pointer; margin-top: 20px; }
    .status-box { font-size: 0.75rem; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; margin-top: 10px; line-height: 1.6; }

    .genre-row { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; margin-bottom: 10px; }
    .genre-info { display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; }
    input[type=range] { width: 100%; accent-color: var(--primary); cursor: pointer; }

    .btn-save-preset { background: #2ecc71; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }

    .setting-item { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; margin-bottom: 10px; }
    .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #444; transition: .4s; border-radius: 24px; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--primary); }
    input:checked + .slider:before { transform: translateX(26px); }
  </style>
</head>
<body>

  <nav>
    <div style="font-family: 'Dongle', sans-serif; font-size: 30px; color: var(--primary); margin-right: 20px; display: flex; align-items: center; gap: 10px; line-height: 0.6;">
        <img src="https://miramarsupermercado.com.br/wp-content/uploads/2024/10/cropped-icone.png" alt="Logo Miramar" style="width: 40px; height: auto;">
        <div style="display: flex; flex-direction: column;">
            <span style="color: #ed6a1b; font-weight: 100; margin-top: 6px">R√ÅDIO</span>
            <span style="color: #ffffff; font-weight: 700;">MIRAMAR</span>
        </div>
    </div>
    <button class="nav-btn active" id="btn-player" onclick="showPage('player')">Est√∫dio ao Vivo</button>
    <button class="nav-btn" id="btn-config" onclick="showPage('config')">Configura√ß√µes</button>
  </nav>

  <div class="main-layout">
    <div id="page-player">
      <div class="player-zone">
        <canvas id="visualizer"></canvas>
        <div class="player-content">
          <div id="status">No Ar</div>
          <div class="album-art" id="album-container">
            <div id="fallback-icon">
                <svg width="80" height="80" viewBox="0 0 24 24" fill="var(--primary)"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
            </div>
            <img id="album-img" alt="Capa">
          </div>
          <div id="current-title">Sintonizando...</div>
          <div class="controls-row">
            <button id="muteBtn" class="round-btn btn-secondary btn-mute" title="Mute/Unmute">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
            </button>
            <button id="playPause" class="round-btn">
              <svg id="icon-play" width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
              <svg id="icon-stop" width="32" height="32" viewBox="0 0 24 24" fill="currentColor" style="display:none;"><path d="M6 6h12v12H6z"/></svg>
            </button>
            <button id="nextBtn" class="round-btn btn-secondary"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg></button>
          </div>
          <div class="progress-container">
            <div class="bar-bg" id="prog-container"><div id="progress-fill"></div></div>
            <div style="display:flex; justify-content:space-between; margin-top:12px; color:var(--text-dim); font-size: 0.85rem;">
              <span id="time-current">00:00</span>
              <span id="time-total">00:00</span>
            </div>
          </div>
        </div>
      </div>
      <div class="sidebar">
        <h4>Buscar M√∫sica</h4>
        <div class="search-box">
            <input type="text" class="search-input" id="musicSearch" placeholder="Pesquisar..." oninput="searchMusic(this.value)">
            <div id="search-results" class="search-results"></div>
        </div>
        <h4>Pr√≥ximas M√∫sicas</h4>
        <div id="playlist" style="flex:1; overflow-y:auto;"><div style="text-align: center; color: #555; margin-top: 20px;">Playlist vazia</div></div>
        <button id="playAd" class="btn-pao" onclick="triggerUrgentAd()">üì¢ AVISO P√ÉO (IMEDIATO)</button>
      </div>
    </div>

    <div id="page-config">
      <div class="config-card">
        <h2>Painel de Controle</h2>
        
        <div style="margin-bottom: 30px;">
          <h3>Interface do Player</h3>
          <div class="setting-item">
            <span>Exibir bot√£o "Pr√≥ximo"</span>
            <label class="switch">
              <input type="checkbox" id="toggle-next-btn" checked onchange="updateInterfaceSettings()">
              <span class="slider"></span>
            </label>
          </div>
          <div class="setting-item">
            <span>Permitir busca na barra de progresso</span>
            <label class="switch">
              <input type="checkbox" id="toggle-progress-seek" checked onchange="updateInterfaceSettings()">
              <span class="slider"></span>
            </label>
          </div>
        </div>

        <div id="status-pastas" class="status-box">Carregando automa√ß√£o...</div>
        
        <div id="genre-controls" style="margin-top:25px; display:none;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="color:var(--primary); margin: 0;">Mix de G√™neros Proporcional</h3>
            <button onclick="saveGenrePreset()" class="btn-save-preset" style="width: auto; padding: 5px 15px;">üíæ SALVAR PRESET</button>
          </div>
          <div id="sliders-container"></div>
          <div id="total-info" style="margin-top:15px; font-weight:bold; text-align:center;">Total: 100%</div>
        </div>

        <button id="build" class="save-btn" style="display:none;">REGENERAR PROGRAMA√á√ÉO</button>
      </div>
    </div>
  </div>

  <audio id="audioA" preload="auto"></audio>
  <audio id="audioB" preload="auto"></audio>
  <audio id="audioAds" preload="auto"></audio>
  <audio id="audioMin" preload="auto"></audio>

<script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const analyser = audioCtx.createAnalyser();
    const mainGain = audioCtx.createGain(); 
    const gainA = audioCtx.createGain(), gainB = audioCtx.createGain(), gainAds = audioCtx.createGain(), gainMin = audioCtx.createGain();
    const audioA = document.getElementById('audioA'), audioB = document.getElementById('audioB'), audioAds = document.getElementById('audioAds'), audioMin = document.getElementById('audioMin');
    
    gainA.gain.value = 1.0; gainB.gain.value = 1.0; gainAds.gain.value = 1.5; gainMin.gain.value = 1.5;
    [audioA, audioB, audioAds, audioMin].forEach(a => {
        a.crossOrigin = "anonymous";
        const source = audioCtx.createMediaElementSource(a);
        let g;
        if(a === audioA) g = gainA;
        else if(a === audioB) g = gainB;
        else if(a === audioAds) g = gainAds;
        else g = gainMin;
        source.connect(g).connect(analyser);
        
        // CORRE√á√ÉO: Pular se houver erro no arquivo
        a.onerror = () => {
          console.error("Erro ao carregar arquivo:", a.src);
          if (a === activePlayer) {
            let nextMusicIdx = -1;
            for (let i = currentIndex + 1; i < playlist.length; i++) { if (playlist[i].isP1) { nextMusicIdx = i; break; } }
            if (nextMusicIdx !== -1) play(nextMusicIdx, true);
          }
        };
    });
    analyser.connect(mainGain).connect(audioCtx.destination);

    let playlist = [], currentIndex = -1, activePlayer = audioA;
    let musicLibrary = {}, filesP3 = [], filesP4 = [], filesAds = [];
    let genreMix = {}; 
    let isMuted = false;

    let settings = { showNextBtn: true, allowSeek: true };

    async function unlockAudio() { if (audioCtx.state === 'suspended') await audioCtx.resume(); }

    document.getElementById('muteBtn').onclick = function() {
        isMuted = !isMuted;
        mainGain.gain.setValueAtTime(isMuted ? 0 : 1, audioCtx.currentTime);
        this.classList.toggle('active', isMuted);
        this.innerHTML = isMuted ? 
          `<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.41.32-.85.59-1.32.79v2.06c1.02-.22 1.97-.68 2.8-1.32l2.25 2.25L21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>` : 
          `<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>`;
    };

    document.getElementById('playPause').onclick = function() {
        if (activePlayer.paused) {
            activePlayer.play();
            updatePlayPauseUI(true);
        } else {
            activePlayer.pause();
            updatePlayPauseUI(false);
        }
    };

    function updatePlayPauseUI(isPlaying) {
        document.getElementById('icon-play').style.display = isPlaying ? 'none' : 'block';
        document.getElementById('icon-stop').style.display = isPlaying ? 'block' : 'none';
    }

    document.getElementById('prog-container').onclick = function(e) {
        if (!settings.allowSeek) return;
        if (currentIndex === -1 || !activePlayer || !activePlayer.duration) return;
        const rect = this.getBoundingClientRect();
        const pos = (e.clientX - rect.left) / rect.width;
        activePlayer.currentTime = pos * activePlayer.duration;
    };

    function updateInterfaceSettings() {
        settings.showNextBtn = document.getElementById('toggle-next-btn').checked;
        settings.allowSeek = document.getElementById('toggle-progress-seek').checked;
        document.getElementById('nextBtn').style.display = settings.showNextBtn ? 'flex' : 'none';
        document.getElementById('prog-container').style.cursor = settings.allowSeek ? 'pointer' : 'default';
        localStorage.setItem('miramar_ui_settings', JSON.stringify(settings));
    }

    function loadInterfaceSettings() {
        const saved = localStorage.getItem('miramar_ui_settings');
        if (saved) {
            settings = JSON.parse(saved);
            document.getElementById('toggle-next-btn').checked = settings.showNextBtn;
            document.getElementById('toggle-progress-seek').checked = settings.allowSeek;
        }
        updateInterfaceSettings();
    }

    window.addEventListener('DOMContentLoaded', async () => {
        loadInterfaceSettings();
        await fetchAllM3U(false); 
        if (Object.keys(musicLibrary).length > 0) {
            generatePlaylist(); 
            play(0); 
        }
    });

    setInterval(() => {
        if (Object.keys(musicLibrary).length > 0) { fetchAllM3U(true); }
    }, 1 * 60 * 1000);

    async function fetchAllM3U(silent = false) {
        const statusBox = document.getElementById('status-pastas');
        if (!silent) { statusBox.style.display = 'block'; statusBox.innerHTML = "Lendo playlists..."; }
        musicLibrary = {}; filesP3 = []; filesP4 = []; filesAds = [];
        try {
            const targets = [
                { name: 'miramarsupermercado/Musicas.m3u', type: 'musicas' },
                { name: 'miramarsupermercado/Vinhetas.m3u', type: 'vinhetas' },
                { name: 'miramarsupermercado/Hora.m3u', type: 'hora' },
                { name: 'miramarsupermercado/Aviso.m3u', type: 'aviso' }
            ];
            for (const t of targets) {
                // CORRE√á√ÉO: Caminho relativo explicito para o GitHub
                const res = await fetch('./' + t.name + '?t=' + Date.now());
                if (res.ok) { const text = await res.text(); parseM3U(text, t.type); }
            }
            updateStatusUI();
            if (!silent) { setupGenreUI(); preloadHours(); }
        } catch (e) { if (!silent) statusBox.innerHTML = "‚ùå Erro ao ler arquivos."; }
    }

    function preloadHours() {
        if (filesP4.length === 0) return;
        filesP4.forEach(file => {
            const link = document.createElement('link');
            link.rel = 'preload'; link.as = 'audio'; link.href = file.url;
            document.head.appendChild(link);
        });
    }

    function parseM3U(text, type) {
        const lines = text.split(/\r?\n/);
        let currentName = ""; let currentGenre = "Geral";
        for (let line of lines) {
            line = line.trim();
            if (line.startsWith('#EXTINF:')) {
                const groupMatch = line.match(/group-title="([^"]+)"/);
                if (groupMatch) currentGenre = groupMatch[1];
                const targetMarker = '",';
                const markerPos = line.indexOf(targetMarker);
                if (markerPos !== -1) { currentName = line.substring(markerPos + targetMarker.length).trim(); } 
                else { const lastComma = line.lastIndexOf(','); if (lastComma !== -1) currentName = line.substring(lastComma + 1).trim(); }
            } else if (line !== "" && !line.startsWith('#')) {
                // CORRE√á√ÉO: Garante caminho relativo limpando barras invertidas
                let url = line.replace(/\\/g, '/');
                if (!url.startsWith('http') && !url.startsWith('./')) url = './' + url;
                
                const item = { url: url, name: currentName || line.split('/').pop().replace(/\.[^/.]+$/, ""), genre: currentGenre };
                if (type === 'musicas') { if (!musicLibrary[currentGenre]) musicLibrary[currentGenre] = []; musicLibrary[currentGenre].push(item); } 
                else if (type === 'vinhetas') filesP3.push(item);
                else if (type === 'hora') filesP4.push(item);
                else if (type === 'aviso') filesAds.push(item);
                currentName = ""; 
            }
        }
    }

    function setupGenreUI() {
      const genres = Object.keys(musicLibrary);
      if (genres.length === 0) return;
      const container = document.getElementById('sliders-container');
      container.innerHTML = "";
      document.getElementById('genre-controls').style.display = "block";
      const savedPreset = localStorage.getItem('miramar_genre_preset');
      const preset = savedPreset ? JSON.parse(savedPreset) : null;
      const defaultPerc = Math.floor(100 / genres.length);
      genres.forEach((g, idx) => {
        if (preset && preset[g] !== undefined) { genreMix[g] = preset[g]; } 
        else { genreMix[g] = (idx === genres.length - 1) ? 100 - (defaultPerc * (genres.length - 1)) : defaultPerc; }
        const row = document.createElement('div');
        row.className = "genre-row";
        row.innerHTML = `<div class="genre-info"><span>${g}</span><span id="label-${g}">${genreMix[g]}%</span></div><input type="range" class="genre-slider" data-genre="${g}" min="0" max="100" value="${genreMix[g]}">`;
        container.appendChild(row);
      });
      document.querySelectorAll('.genre-slider').forEach(slider => {
        slider.addEventListener('input', (e) => adjustOtherSliders(e.target.dataset.genre, parseInt(e.target.value)));
      });
    }

    function saveGenrePreset() { localStorage.setItem('miramar_genre_preset', JSON.stringify(genreMix)); alert("Configura√ß√£o de g√™neros salva com sucesso!"); }

    function adjustOtherSliders(changedGenre, newVal) {
      const genres = Object.keys(genreMix);
      if (genres.length <= 1) { genreMix[changedGenre] = 100; updateSliderUI(); return; }
      const oldVal = genreMix[changedGenre], diff = newVal - oldVal;
      genreMix[changedGenre] = newVal;
      const others = genres.filter(g => g !== changedGenre);
      let totalOthers = others.reduce((sum, g) => sum + genreMix[g], 0);
      if (totalOthers > 0) {
        others.forEach(g => {
          const share = genreMix[g] / totalOthers;
          genreMix[g] = Math.max(0, Math.round(genreMix[g] - (diff * share)));
        });
      } else {
        others.forEach(g => genreMix[g] = Math.max(0, Math.round(100 - newVal) / others.length));
      }
      let currentTotal = Object.values(genreMix).reduce((a, b) => a + b, 0);
      if (currentTotal !== 100) genreMix[others[0]] += (100 - currentTotal);
      updateSliderUI();
    }

    function updateSliderUI() {
      for (let g in genreMix) {
        const input = document.querySelector(`.genre-slider[data-genre="${g}"]`);
        const label = document.getElementById(`label-${g}`);
        if (input) input.value = genreMix[g];
        if (label) label.textContent = genreMix[g] + "%";
      }
    }

    function updateStatusUI() {
      const totalMusic = Object.values(musicLibrary).flat().length;
      document.getElementById('status-pastas').innerHTML = `M√∫sicas: ${totalMusic} | Vinhetas: ${filesP3.length}`;
      document.getElementById('build').style.display = 'block';
    }

    function generatePlaylist() {
      playlist = []; const MAX_TRACKS = 300; const genres = Object.keys(musicLibrary);
      let tempMusicList = []; let recentP3Urls = [];
      genres.forEach(g => {
        const source = [...musicLibrary[g]].sort(() => Math.random() - 0.5);
        const count = Math.round(((genreMix[g] || 50) / 100) * MAX_TRACKS);
        for(let i=0; i<count; i++) {
          if (tempMusicList.length >= MAX_TRACKS || source.length === 0) break;
          const music = source.pop(); tempMusicList.push({...music, isP1: true});
        }
      });
      tempMusicList.sort(() => Math.random() - 0.5);
      tempMusicList.forEach((m, i) => {
        playlist.push(m);
        if (i % 2 === 0 && filesP4.length) playlist.push({ isHoraDinamica: true });
        if (filesP3.length > 0) {
          let pool = filesP3.filter(v => !recentP3Urls.includes(v.url));
          if (pool.length === 0) pool = filesP3;
          const chosen = pool[Math.floor(Math.random() * pool.length)];
          playlist.push({ ...chosen, isP3: true });
          recentP3Urls.push(chosen.url);
          if (recentP3Urls.length > 3) recentP3Urls.shift();
        }
      });
      render();
    }

    document.getElementById('build').onclick = () => { generatePlaylist(); play(0); };

    async function play(i, manual = false) {
      if (i < 0 || i >= playlist.length) return;
      await unlockAudio();
      const item = playlist[i];
      if (item.isHoraDinamica) { runHora(i); return; }
      
      const prevPlayer = activePlayer;
      const prevGain = (prevPlayer === audioA) ? gainA : gainB;
      activePlayer = (prevPlayer === audioA) ? audioB : audioA;
      const activeGain = (activePlayer === audioA) ? gainA : gainB;
      
      activePlayer.src = item.url;
      activePlayer.load();
      currentIndex = i;
      activeGain.gain.cancelScheduledValues(audioCtx.currentTime);
      
      if (item.isP3 || manual) {
          activeGain.gain.setValueAtTime(1.0, audioCtx.currentTime);
          prevGain.gain.setValueAtTime(0, audioCtx.currentTime);
          prevPlayer.pause();
      } else {
          activeGain.gain.setValueAtTime(0, audioCtx.currentTime);
          activeGain.gain.linearRampToValueAtTime(1.0, audioCtx.currentTime + 0.8);
          prevGain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.8);
      }
      
      activePlayer.play().then(() => updatePlayPauseUI(true)).catch(() => {
          document.getElementById('current-title').textContent = "‚ö†Ô∏è Clique na tela para ouvir o som";
      });
      
      document.getElementById('current-title').textContent = item.name;
      updateAlbumArt(item.url, item.name); 

      let nextRealIdx = -1;
      for (let j = i + 1; j < playlist.length; j++) { if (!playlist[j].isHoraDinamica) { nextRealIdx = j; break; } }
      if (nextRealIdx !== -1) {
          const nextItem = playlist[nextRealIdx];
          const standbyPlayer = (activePlayer === audioA) ? audioB : audioA;
          if (standbyPlayer.src !== nextItem.url) { standbyPlayer.src = nextItem.url; standbyPlayer.load(); }
      }
      
      activePlayer.ontimeupdate = function() {
        document.getElementById('progress-fill').style.width = (this.currentTime / this.duration * 100) + "%";
        document.getElementById('time-current').textContent = formatTime(this.currentTime);
        document.getElementById('time-total').textContent = formatTime(this.duration);
        if (!item.overlap && this.duration > 5) {
            if (this.duration - this.currentTime <= 0.5) { item.overlap = true; play(i + 1); }
        }
      };
      activePlayer.onended = () => { if (!item.overlap) play(i + 1); };
      render();
    }

    async function runHora(idx) {
        const now = new Date();
        const hS = "HRS" + now.getHours().toString().padStart(2, '0');
        const mS = "MIN" + now.getMinutes().toString().padStart(2, '0');
        const fH = filesP4.find(f => f.name.includes(hS));
        const fM = filesP4.find(f => f.name.includes(mS));
        if (!fH) return play(idx + 1);
        currentIndex = idx;
        document.getElementById('current-title').textContent = `üé§ Hora Certa: ${now.getHours()}:${now.getMinutes()}`;
        if (fM) { audioMin.src = fM.url; audioMin.load(); }
        let nextRealIdx = -1;
        for (let j = idx + 1; j < playlist.length; j++) { if (!playlist[j].isHoraDinamica) { nextRealIdx = j; break; } }
        if (nextRealIdx !== -1) {
            const standby = (activePlayer === audioA) ? audioB : audioA;
            standby.src = playlist[nextRealIdx].url; standby.load();
        }
        audioAds.src = fH.url; audioAds.play();
        audioAds.onended = () => { if (fM) { audioMin.play(); audioMin.onended = () => play(idx + 1, true); } else { play(idx + 1, true); } };
    }

    function removeTrack(absoluteIndex) {
        let j = absoluteIndex + 1; while (j < playlist.length && !playlist[j].isP1) { j++; }
        playlist.splice(absoluteIndex, (j - absoluteIndex));
        if (playlist.length < 50) generatePlaylist();
        render();
    }

    function triggerUrgentAd() {
        if (filesAds.length === 0) { alert("Playlist de Avisos vazia!"); return; }
        const randomAd = filesAds[Math.floor(Math.random() * filesAds.length)];
        const currentMusicGain = (activePlayer === audioA) ? gainA : gainB;
        const now = audioCtx.currentTime; const fadeTime = 0.5;
        currentMusicGain.gain.cancelScheduledValues(now);
        currentMusicGain.gain.setValueAtTime(currentMusicGain.gain.value, now);
        currentMusicGain.gain.exponentialRampToValueAtTime(0.08, now + fadeTime);
        const btn = document.getElementById('playAd');
        btn.innerText = "üîä TOCANDO AGORA (2x)..."; btn.style.background = "#e74c3c";
        let playsCount = 0; audioAds.src = randomAd.url; audioAds.play();
        audioAds.onended = () => {
            playsCount++;
            if (playsCount < 2) { audioAds.currentTime = 0; audioAds.play(); } 
            else {
                const endNow = audioCtx.currentTime;
                currentMusicGain.gain.cancelScheduledValues(endNow);
                currentMusicGain.gain.setValueAtTime(currentMusicGain.gain.value, endNow);
                currentMusicGain.gain.exponentialRampToValueAtTime(1.0, endNow + fadeTime);
                btn.innerText = "üì¢ AVISO P√ÉO (IMEDIATO)"; btn.style.background = "#d6741d";
            }
        };
    }

    function searchMusic(query) {
        const resultsDiv = document.getElementById('search-results');
        if (!query) { resultsDiv.style.display = 'none'; return; }
        const allMusics = Object.values(musicLibrary).flat();
        const filtered = allMusics.filter(m => m.name.toLowerCase().includes(query.toLowerCase())).slice(0, 15);
        resultsDiv.innerHTML = filtered.map(m => `<div class="search-item"><span class="search-item-name">${m.name}</span><div class="search-item-actions"><button class="btn-action btn-next" onclick="insertMusicByPosition('${m.url}', '${m.name}', 'next')">Pr√≥xima</button><button class="btn-action btn-last" onclick="insertMusicByPosition('${m.url}', '${m.name}', 'last')">√öltima</button></div></div>`).join('');
        resultsDiv.style.display = 'block';
    }

    function insertMusicByPosition(url, name, type) {
        let musicItemsIndices = [];
        playlist.forEach((item, idx) => { if (item.isP1 && idx > currentIndex) musicItemsIndices.push(idx); });
        if (musicItemsIndices.length > 0) {
            const newMusic = { url, name, isP1: true };
            if (type === 'next') { const targetIdx = musicItemsIndices[0]; playlist.splice(targetIdx, 0, newMusic); } 
            else { const targetRelativeIndex = Math.min(4, musicItemsIndices.length - 1); const targetIdx = musicItemsIndices[targetRelativeIndex]; playlist.splice(targetIdx + 1, 0, newMusic); }
        } else { playlist.push({ url, name, isP1: true }); }
        document.getElementById('search-results').style.display = 'none';
        document.getElementById('musicSearch').value = ''; render();
    }

    function showPage(p) {
      document.getElementById('page-player').style.display = (p === 'player') ? 'flex' : 'none';
      document.getElementById('page-config').style.display = (p === 'config') ? 'block' : 'none';
      document.getElementById('btn-player').className = p === 'player' ? 'nav-btn active' : 'nav-btn';
      document.getElementById('btn-config').className = p === 'config' ? 'nav-btn active' : 'nav-btn';
    }

    function render() {
        const container = document.getElementById('playlist');
        let html = ""; let count = 0;
        for (let i = currentIndex + 1; i < playlist.length; i++) {
            const item = playlist[i];
            if (item.isP1) {
                html += `
                <div class="track-item">
                    <span class="track-name">${item.name}</span>
                    <button class="remove-btn" onclick="removeTrack(${i})" title="Remover">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                    </button>
                </div>`;
                count++;
            }
            if (count >= 5) break;
        }
        container.innerHTML = html || '<div style="text-align: center; color: #555; margin-top: 20px;">Fim da lista</div>';
    }

    function formatTime(t) { if (isNaN(t)) return "00:00"; const m = Math.floor(t/60), s = Math.floor(t%60); return `${m}:${s<10?'0':''}${s}`; }
    
    document.getElementById('nextBtn').onclick = () => {
        let nextMusicIdx = -1;
        for (let i = currentIndex + 1; i < playlist.length; i++) { if (playlist[i].isP1) { nextMusicIdx = i; break; } }
        if (nextMusicIdx !== -1) { play(nextMusicIdx, true); }
    };

    // CORRE√á√ÉO: Removida biblioteca externa para evitar erro de CORS no GitHub. 
    // Foca apenas em imagens locais ou fallback silencioso.
    function updateAlbumArt(audioUrl, musicName) {
      const img = document.getElementById('album-img'), fb = document.getElementById('fallback-icon');
      const fileNameForArt = musicName.replace(/\//g, '_');
      const pngPath = `./300x300/${fileNameForArt}.png`;
      const jpgPath = `./300x300/${fileNameForArt}.jpg`;

      const showFallback = () => { img.style.display = 'none'; fb.style.display = 'block'; };

      const testPng = new Image();
      testPng.src = pngPath;
      testPng.onload = () => { img.src = pngPath; img.style.display = 'block'; fb.style.display = 'none'; };
      testPng.onerror = () => {
          const testJpg = new Image();
          testJpg.src = jpgPath;
          testJpg.onload = () => { img.src = jpgPath; img.style.display = 'block'; fb.style.display = 'none'; };
          testJpg.onerror = showFallback;
      };
    }

    const canvas = document.getElementById('visualizer'), ctx = canvas.getContext('2d');
    function draw() {
      requestAnimationFrame(draw);
      canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight;
      const data = new Uint8Array(analyser.frequencyBinCount);
      analyser.getByteFrequencyData(data);
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      let g = ctx.createLinearGradient(0, canvas.height, 0, 0);
      g.addColorStop(0, "rgba(243, 156, 18, 0)"); g.addColorStop(1, "rgba(243, 156, 18, 0.6)");
      const barW = (canvas.width / data.length) * 10;
      for(let i=0; i<data.length; i++) {
        let h = data[i] * (canvas.height / 255); ctx.fillStyle = g;
        ctx.fillRect(i*(barW+2), canvas.height - h, barW, h);
      }
    }
    draw();
</script>
</body>
</html>

